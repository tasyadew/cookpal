<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CookPAL</title>
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
</head>

<body>
    <nav id="navbar">
        <img src="./assets/cookpal.png" width="10%" height="10%" class="navbar-item">
        <div id="auth-container">
            <div id="welcome-message" class="navbar-item"></div>
            <div>
    </nav>

    <section id="banner">
    </section>

    <section id="browse">
        <div class="meal-search">
            <h1>Find Your Perfect Dish!</h1>
            <div class="meal-search-box">
                <input type="text" class="search-control" placeholder="Search recipes..." id="search-input">
                <button type="submit" class="search-btn btn" id="search-btn">
                    <i class="fa-solid fa-magnifying-glass fa-sm"></i>
                </button>
            </div>
        </div>
    </section>

    <section id="recipe">
        <h1>Browse Recipes</h1>
        <div id="recipe-container"></div>
    </section>

    <footer>
        <div>
            <p>Â© CookPAL 2023. All Rights Reserved</p>
        </div>
    </footer>
</body>

<script src="./js/main.js"></script>

<!-- Firebase Auth Module -->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp }
        from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut }
        from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, updateDoc, arrayUnion, arrayRemove }
        from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDDH3bFZb8rIP9l1sQ8aBZHCQbhTgn3wOk",
        authDomain: "cookpal-a47f7.firebaseapp.com",
        projectId: "cookpal-a47f7",
        storageBucket: "cookpal-a47f7.appspot.com",
        messagingSenderId: "568342145857",
        appId: "1:568342145857:web:00a747e32b4c59746b8fc0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    console.log(app);
    let user = null;
    let username = "N/A";
    let welcomeMsg = document.getElementById("welcome-message");
    onAuthStateChanged(auth, (currentUser) => {
        // Check if button already exists and remove it
        let authButton = document.getElementById("authButton");
        if (authButton) authButton.remove();

        // If the user is logged in
        if (currentUser) {
            user = currentUser;
            // Check if account data exists
            const docRef = doc(db, "user", currentUser.uid);
            getDoc(docRef).then((docSnap) => {
                if (docSnap.exists()) username = docSnap.data()['username'];

                welcomeMsg.innerHTML = "Welcome, " + username + "!";
            });
        }
        else {
            welcomeMsg.innerHTML = "Please sign in!";
        }

        // Create button based on if user is already signed in or not
        welcomeMsg.insertAdjacentElement("afterend", createAuthButton(currentUser));

        const parentDiv = document.getElementById("recipe-container");
        const children = parentDiv.children;
        for (let i = 0; i < children.length; i++) {
            const child = children[i];
            const mealID = child.mealID;
            let heartIcon = child.querySelector(".card > .card__info > .card__footer > .icons > .fa-heart");
            if (currentUser) {
                // Check if already liked
                const docRef = doc(db, "user", currentUser.uid);
                getDoc(docRef).then((docSnap) => {
                    if (docSnap.data()['like']) {
                        if (docSnap.data()['like'].includes(mealID)) {
                            heartIcon.liked = true;
                        } else {
                            heartIcon.liked = false;
                        }
                    } else {
                        heartIcon.liked = false;
                    }

                    if (i == 0) console.log(docSnap.data()['like']);
                    console.log(mealID + " liked? " + heartIcon.liked);
                });
            } else {
                heartIcon.liked = false;
            }
        }
    });

    let recipeContainer = document.getElementById("recipe-container");
    let n = 0;
    let numLike = 0;
    let numComment = 0;
    let mealID = 0;
    fetch('https://www.themealdb.com/api/json/v1/1/search.php?s=')
        .then(response => response.json())
        .then(json => {
            n = Object.keys(json.meals).length;
            console.log(json.meals[0]);

            if (n == 0) {

            } else {
                for (var i = 0; i < n; i++) {
                    mealID = json.meals[i].idMeal;

                    // Check if account data exists
                    const docRef = doc(db, "recipe", mealID);
                    getDoc(docRef).then((docSnap) => {
                        if (docSnap.exists()) {
                            numLike = docSnap.data()['numLike'];
                            numComment = docSnap.data()['comment'].length;
                        } else {
                            numLike = 0;
                            numComment = 0;
                        }
                    });

                    recipeContainer.insertAdjacentElement("beforeend", createCardContainer(user, mealID, json.meals[i].strMeal, json.meals[i].strCategory, json.meals[i].strMealThumb, null, numLike, numComment));
                }
            }
        });

    function createAuthButton(user) {
        const login = () => {
            window.location.href = './pages/login.html';
        };

        const logout = () => {
            signOut(auth)
                .then(() => {
                    // User signed out successfully
                    console.log("User signed out");
                })
                .catch((error) => {
                    // An error occurred while signing out
                    console.log("Error signing out:", error);
                });
        };

        let authButton = document.createElement("button");
        authButton.id = "authButton";

        if (user) {
            //<button id="authButton" onclick="logout()">Log Out</button>
            authButton.innerHTML = "Log Out";
            authButton.addEventListener("click", logout);
        } else {
            //<button id="authButton" onclick="login()">Log In</button>
            authButton.innerHTML = "Log In";
            authButton.addEventListener("click", login);
        }

        return authButton;
    }

    function createCardContainer(user, mealID, name, category, imgurl, tagsList, numLike, numComment) {
        const updateLike = (element, user) => {
            console.log(mealID + " clicked!");
            // if (user) {
            //     element.liked = !element.liked;
            //     if (element.liked) {
            //         updateDoc(doc(db, "user", user.uid), {
            //             like: arrayUnion(mealID)
            //         });
            //     } else {
            //         updateDoc(doc(db, "user", user.uid), {
            //             like: arrayRemove(mealID)
            //         });
            //     }
            // } else {
            //     element.liked = false;
            // }
            console.log(mealID + ": " + element.liked);
        };

        const updateIcon = (element) => {
            if (element.liked) {
                element.className = "recipe-icon fa-solid fa-heart fa-xl";
            } else {
                element.className = "recipe-icon fa-regular fa-heart fa-xl";
            }
        };

        // Create card container
        let cardContainer = document.createElement("div");
        cardContainer.className = "card-container";
        cardContainer.mealID = mealID;

        // Create card
        let card = document.createElement("div");
        card.className = "card";
        cardContainer.appendChild(card);

        // Create card image
        let cardImg = document.createElement("div");
        cardImg.className = "card__img";
        card.appendChild(cardImg);

        // Create image element
        let img = document.createElement("img");
        img.src = imgurl;
        img.alt = "Image of " + name;
        cardImg.appendChild(img);

        // Create icons container
        let icons = document.createElement("div");
        icons.className = "icons";
        cardImg.appendChild(icons);

        // Create bookmark icon
        let bookmarkIcon = document.createElement("i");
        bookmarkIcon.className = "fa-regular fa-bookmark fa-xl";
        icons.appendChild(bookmarkIcon);

        // Create card info
        let cardInfo = document.createElement("div");
        cardInfo.className = "card__info";
        card.appendChild(cardInfo);

        // Create food category paragraph
        let foodCategory = document.createElement("p");
        foodCategory.innerHTML = category;
        cardInfo.appendChild(foodCategory);

        // Create recipe name heading
        let recipeName = document.createElement("h2");
        recipeName.innerHTML = name;
        cardInfo.appendChild(recipeName);

        // Create card footer
        let cardFooter = document.createElement("div");
        cardFooter.className = "card__footer";
        cardInfo.appendChild(cardFooter);

        // Create tags container
        let tags = document.createElement("div");
        tags.className = "tags";
        tags.innerHTML = "Tags";
        cardFooter.appendChild(tags);

        // Create icons container in footer
        let footerIcons = document.createElement("div");
        footerIcons.className = "icons";
        cardFooter.appendChild(footerIcons);

        // Create comment icon
        let commentIcon = document.createElement("i");
        commentIcon.className = "recipe-icon fa-regular fa-comment fa-xl";
        footerIcons.appendChild(commentIcon);

        // Create comment count
        let commentCount = document.createElement("div");
        commentCount.className = "icon-counter";
        commentCount.innerHTML = numComment;
        footerIcons.appendChild(commentCount);

        // Create heart icon
        let heartIcon = document.createElement("button");
        heartIcon.className = "recipe-icon fa-regular fa-heart fa-xl";
        heartIcon.liked = false;
        heartIcon.addEventListener("click", updateLike(heartIcon, user));
        heartIcon.addEventListener("propertychange", updateIcon(heartIcon));
        footerIcons.appendChild(heartIcon);

        // Create heart count
        let heartCount = document.createElement("div");
        heartCount.className = "icon-counter";
        heartCount.innerHTML = numLike;
        footerIcons.appendChild(heartCount);

        return cardContainer;
    }
</script>

</html>